<!DOCTYPE html>
<html lang="en-US">

<head>
<title>WeeNAS Install Script Generator</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href= "style.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="tzNamesLib.js"></script>
<script type="text/javascript" src="config-generator.js"></script>
<script>  
  function sambaSummary() {
    var summary = '<b>Samba</b> <span class="right-justify">';
	if (document.getElementById('samba-home').checked) {
      summary += '/home/<i>user</i> ';
	}
	if (document.getElementById('samba-shared').checked) {
      summary += '/home/shared';
	}
    summary += '</span>';
    document.getElementById('samba-summary').innerHTML = summary; 
	generateScript();
  }
  
  function servicesSummary() {
    var summary = '<b>Services</b> <span class="right-justify">';
	if (document.getElementById('services-monit').checked) {
      summary += 'Monit ';
	}
	if (document.getElementById('services-pop3').checked) {
      summary += 'POP3 ';
	}
	if (document.getElementById('services-smtp').checked) {
      summary += 'SMTP ';
	}
	if (document.getElementById('services-web').checked) {
      summary += 'Web';
	}
    summary += '</span>';
    document.getElementById('services-summary').innerHTML = summary; 
	generateScript();
  }
  
  function toggleNetworkStatic() {
    // Show or hide manual configuration fields based on DHCP dropdown.
    if (document.getElementById('network-dhcp').value === 'yes') {
	  document.getElementById('network-static').style.display='none';
	}
	else {
	  document.getElementById('network-static').style.display='block';
	}
  }

  function generateScript() {
    var scriptOutput = '# The following commands must be run as root.\n';

    // Storage
    scriptOutput += '\n# Storage Configuration\n';
    scriptOutput += 'sysrc fsck_y_enable="YES"\n';
	if (document.getElementById('storage-makefs').value == 'Yes') {
      scriptOutput += 'makefs -t ufs ' + document.getElementById('storage-dev').value + '\n';
	}
    scriptOutput += 'tunefs -L ' + document.getElementById('storage-label').value + ' ' + document.getElementById('storage-dev').value + '\n';
    scriptOutput += 'echo "/dev/ufs/' + document.getElementById('storage-label').value + ' ' + document.getElementById('storage-mount').value + ' ufs rw noatime" >> /etc/fstab\n';
    scriptOutput += 'mount ' + document.getElementById('storage-label').value + '\n';

    // Users
    scriptOutput += '\n# User Configuration\n';
	var users = document.getElementById('user-trusted').value.split(' ');
	for (var i=0; i<users.length; i++) {
      scriptOutput += 'pw group add ' + users[i] + '\n';
      scriptOutput += 'pw user add -n ' + users[i] + ' -c ' + users[i] + ' -g ' + users[i] + ' -G wheel -w random >> /root/vault.txt' + '\n';
	}
	users = document.getElementById('user-regular').value.split(' ');
	for (var i=0; i<users.length; i++) {
      scriptOutput += 'pw group add ' + users[i] + '\n';
      scriptOutput += 'pw user add -n ' + users[i] + ' -c ' + users[i].charAt(0).toUpperCase() + ' -g ' + users[i] + ' -w random >> /root/vault.txt' + '\n';
	}
	scriptOutput += 'chmod 400 /root/vault.txt\n';
	
	// Samba
    scriptOutput += '\n# Samba Configuration\n';
	scriptOutput += 'pkg install -y samba4\n';

    // Reboot
    scriptOutput += '\n# Initial user passwords reminder\n';
    scriptOutput += 'cat /root/vault.txt\n';
    scriptOutput += '\n# Be sure to have users change their passwords and then delete /root/vault.txt\n';
    scriptOutput += '\n# Restart the system for changes to take effect.\n';
	  scriptOutput += 'shutdown -r now\n';
  }
</script>
</head>

<body onload="refreshAll();">

<header>
<h1>WeeNAS Install Script Generator</h1>
</header>

<main>
<h2 class="center">Configuration Options</h2>
<form action="javascript:generateScript();">

<details open>
<summary><b>Identity</b> <span class='right-justify' id='identity-summary'></span></summary>
<table>
  <tr><td><label>Hostname</label></td><td><input id="identity-hostname" onchange="identity();" type="text" value="weenas"></td></tr>
  <tr><td><label>Domain</label></td><td><input id="identity-domain" onchange="identity();" type="text" value="local"></td></tr>
</table>
</details>

<details open>
<summary><b>Time</b> <span class="right-justify" id="time-summary"></span></summary>
<table>
<tr><td><label>Timezone Path</label></td><td colspan="2">
  <select id="time-area" onchange="tzUpdateLocations('time-area', 'time-location'); time();">
    <option>Africa</option>
    <option>America</option>
    <option>Antarctica</option>
    <option>Asia</option>
    <option>Atlantic</option>
    <option>Australia</option>
    <option selected>Etc</option>
    <option>Europe</option>
    <option>Indian</option>
    <option>Pacific</option>
  </select>
  /
  <select id="time-location" onchange="time()">
    <option>UTC</option>
  </select>
</td></tr>
</table>
<ul>
  <li>For the timezone path, choose the location closest to where you live.</li>
</ul>
</details>

<details open>
<summary><b>Users</b> <span class="right-justify" id="user-summary"></span></summary>
<table>
<tr><td><label>Trusted Users</label></td><td><input id="user-trusted" onchange="users();" size="32" type="text" pattern="[a-z ]+"></td></tr>
<tr><td><label>Regular Users</label></td><td><input id="user-regular" onchange="users();" size="64" type="text" pattern="[a-z ]+"></td></tr>
</table>
<ul>
<li>Account names should be lowercase and separated by spaces.</li>
<li>Trusted users will be added to the wheel group and can su to root.</li>
<li>Default accounts freebsd and toor will be locked.</li>
<li>There must be at least one trusted user or you will lose access to root!</li>
</ul>
</details>

<p class="reverse-divider">Any configuration below this point is optional and may be left at default values.</p>

<details>
<summary><b>Network</b> <span class="right-justify" id="network-summary"></span></summary>
<table>
  <tr><td><label>Use automatic configuration (DHCP)?</label></td>
  <td><select id="network-dhcp" onchange="toggleNetworkStatic(); network(); dns();"><option>Yes</option><option>No</option></select></td></tr>
</table>

<!-- Static config stuff.  Hide if DHCP. -->
<table id="network-static">
  <tr><td><label>Interface Name</label></td><td><input id="network-interface" onchange="network();" type="text" value="ue0" readonly></td></tr>
  <tr><td><label>IPv4 Address</label></td><td><input id="network-ip" onchange="network();" type="text" value="192.168.0.100" pattern="[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"></td></tr>
  <tr><td><label>Network Mask</label></td><td><input id="network-mask" onchange="network();" type="text" value="255.255.255.0" pattern="[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"></td></tr>
  <tr><td><label>Gateway</label></td><td><input id="network-gateway" onchange="network();" type="text" value="192.168.0.1" pattern="[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"></td></tr>
  </table>
</details>

<details>
<summary><b>DNS</b> <span class="right-justify" id="dns-summary"></span></summary>
<table>
  <tr><td><label>DNS Provider</label></td>
    <td>
      <input id="dns-dhcp" name="dns-provider" type="radio" onchange="dns();">DHCP</input>
      <input id="dns-google" name="dns-provider" type="radio" onchange="dns();">Google</input> <!-- 8.8.8.8, 8.8.4.4 -->
      <input id="dns-opendns" name="dns-provider" type="radio" onchange="dns();">OpenDNS</input> <!-- 208.67.222.222, 208.67.220.220 -->
      <input id="dns-custom" name="dns-provider" type="radio" onchange="dns();">Custom</input>
    </td></tr>
    <tr><td><label>Primary DNS</label></td><td><input id="dns-primary" onchange="dns();" type="text" value="208.67.222.222" pattern="[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"></td></tr>
    <tr><td><label>Secondary DNS</label></td><td><input id="dns-secondary" onchange="dns();" type="text" value="208.67.220.220" pattern="[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}"></td></tr>
</table>
</details>

<details>
  <summary id="storage-summary">Storage</summary>
  <table>
    <tr><td><label>Device Name</label></td><td><input id="storage-dev" onchange="storage();" type="text" value="da0" pattern="[a-z]{2}[0-9]{1}"></td></tr>
    <tr><td><label>Filesystem Label</label></td><td><input id="storage-label" onchange="storage();" type="text" value="homefs" readonly></td></tr>
    <tr><td><label>Mount Point</label></td><td><input id="storage-mount" onchange="storage();" type="text" value="/home" readonly></td></tr>
  </table>
  <ul>
    <li>If an existing FreeBSD partition is found, the flash drive will be used as-is without overwriting.  Otherwise, the entire contents will be erased!</li>
  </ul>
</details>

<details>
<summary id="samba-summary">Samba</summary>
<table>
<tr><td><input id="samba-home" onchange="sambaSummary();" type="checkbox" value="yes" checked></td><td><label>User Home Directories</label></td></tr>
<tr><td><input id="samba-shared" onchange="sambaSummary();" type="checkbox" value="yes" checked></td><td><label>Shared Directory</label></td></tr>
</table>
</details>

<details>
<summary id="services-summary">Services</summary>
<table>
<tr><td><input id="services-monit" onchange="servicesSummary();" type="checkbox" value="yes"></td><td><label>System Monitoring (Monit)</label></td></tr>
<tr><td><input id="services-pop3" onchange="servicesSummary();" type="checkbox" value="yes"></td><td><label>POP3 Email</label></td></tr>
<tr><td><input id="services-smtp" onchange="servicesSummary();" type="checkbox" value="yes"></td><td><label>SMTP Email</label></td></tr>
<tr><td><input id="services-web" onchange="servicesSummary();" type="checkbox" value="yes"></td><td><label>Web Server</label></td></tr>
</table>
</details>

<input class="right-justify" type="submit" value="Generate Script">
</form>
</main>

<aside>
<h2 class="center">Script Output</h2>
<div id="script-output">
#!/bin/sh
# Auto-generated WeeNAS installer script.
# https://davescodemusings.github.io/WeeNAS/
# The following commands must be run as root.

# Identity
<span id='identity-commands'></span>
# Network
<span id='network-commands'></span>
# DNS
<span id='dns-commands'></span>
# Time
<span id='time-commands'></span>
# Storage
<span id='storage-commands'></span>
# Users
<span id='user-commands'></span>
</div>
<p>Copy the commands from the classic beige box green screen monitor and paste them into your terminal emulator to configure your Raspberry PI for WeeNAS.</p>
</aside>

</body>

</html>