<!DOCTYPE html>

<!-- Mockup of new WeeNAS admin interface. -->

<html lang="en-US">

<head>
  <title>User Accounts</title>
  <meta charset="utf-8">
  <link href="common.css" rel="stylesheet" type="text/css">
  <script src="common.js"></script>
  <script>
    const accountPrivilege = [ 'Standard User', 'Power User', 'Admin User' ];
    function displayAccountHealth(accountHealth) {
      document.getElementById('ssh-auth-failed').innerHTML = accountHealth.failed_ssh;
      document.getElementById('su-auth-failed').innerHTML = accountHealth.failed_su;
    }

    function displayAccountList(accountList) {
      let list = '<option selected>[new]</option>';

      // Sort the services in alpha order for readability.
      let accounts = Object.keys(accountList).sort();
      for (let i = 0; i < accounts.length; i++) {
        list += `<option>${accounts[i]}</option>`;
      }
      document.getElementById('system-account-list').innerHTML = list;
    }

    function displaySystemAccountDetails(systemAccountDetails) {
      if (systemAccountDetails) {
        document.getElementById('system-account-login').value = systemAccountDetails.login;
        let accountLevel = 0;
        if (!systemAccountDetails.shell.match(/nologin/)) {
          accountLevel = 1;
        }
        document.getElementById('system-account-privilege').value = accountPrivilege[accountLevel];
        let gecosFields = systemAccountDetails.gecos.split(",", 5);

        // The & is shorthand for login name with first letter capitalized.
        gecosFields[0] = gecosFields[0].replace(/&/, systemAccountDetails.login.charAt(0).toUpperCase() + systemAccountDetails.login.slice(1));
        document.getElementById('system-account-fullname').value = gecosFields[0];
        document.getElementById('system-account-room').value = gecosFields[1] || "";
        document.getElementById('system-account-phone').value = gecosFields[2] || "";
        document.getElementById('system-account-phone-alt').value = gecosFields[3] || "";
        document.getElementById('system-account-email-alt').value = gecosFields[4] || "";
      }
      else {
        document.getElementById('system-account-privilege').value = accountPrivilege[0];
        document.getElementById('system-account-login').value = "";
        document.getElementById('system-account-fullname').value = "";
        document.getElementById('system-account-room').value = "";
        document.getElementById('system-account-phone').value = "";
        document.getElementById('system-account-phone-alt').value = "";
        document.getElementById('system-account-email-alt').value = "";
      }
    }

    function displaySmbAccountDetails(smbAccountDetails) {
      if (smbAccountDetails) {
        document.getElementById('fileshares').checked = smbAccountDetails.enabled;
      }
    }

    function getAccountDetails(login) {
      if (login == "[new]") {
        document.getElementById('create-button').style.display = 'inline';
        document.getElementById('update-button').style.display = 'none';
        displaySystemAccountDetails();
        // displaySmbAccountDetails();
      }
      else {
        document.getElementById('create-button').style.display = 'none';
        document.getElementById('update-button').style.display = 'inline';
        AJAX('GET', '/system/account/' + login, displaySystemAccountDetails);
        // AJAX('GET', '/smb/account/' + login, displaySmbAccountDetails);
      }
    }
  </script>
</head>

<body
  onload="AJAX('GET', '/system/health/summary/program', displayAccountHealth); AJAX('GET', '/system/account', displayAccountList);">
  <p class="caution">
    This is a partially functioning mock-up. User accounts cannot be created or updated.</p>

  <form>
    <fieldset>
      <legend>User Account Health</legend>
      <button class="refresh" onclick="AJAX('GET', '/system/health/summary/program', displayAccountHealth);"
        type="button">&#x1F504;</button>
      <table>
        <colgroup>
          <col style="width: 20%;">
          <col>
        </colgroup>
        <tr>
          <th>Recent Authentications</th>
          <th>Status</th>
        </tr>
        <tr>
          <td>ssh</td>
          <td id="ssh-auth-failed"></td>
        </tr>
        <tr>
          <td>su</td>
          <td id="su-auth-failed"></td>
        </tr>
      </table>
    </fieldset>

    <fieldset>
      <legend>User Account Management</legend>
      <button class="refresh" onclick="AJAX('GET', '/system/account', displayAccountList);"
        type="button">&#x1F504;</button>
      <table>
        <colgroup>
          <col style="width: 20%;">
          <col>
        </colgroup>
        <thead>
          <tr>
            <th>User Account</th>
            <th>Properties</th>
          </tr>
        </thead>

        <!-- TODO: Limit allowed characters in GECOS fields, i.e. not commas, since they are comma separated. -->
        <tbody>
          <tr>
            <td rowspan="5"><select onclick="getAccountDetails(document.getElementById('system-account-list').value);"
                size="6" id="system-account-list" style="width: 85%;"></select></td>
          </tr>
          <tr>
            <td>
              <input id="system-account-login" placeholder="Login Name" readonly type="text">
              <select id="system-account-privilege">
                <option><script>document.write(accountPrivilege[0]);</script></option>
                <option><script>document.write(accountPrivilege[1]);</script></option>
                <option><script>document.write(accountPrivilege[2]);</script></option>
              </select>
            </td>
          </tr>
          <tr>
            <td><input class="optional" id="system-account-fullname" placeholder="Full Name" type="text">
              <input class="optional" id="system-account-room" placeholder="Room No. / Location" type="text"></td>
          </tr>
          <tr>
            <td><input class="optional" id="system-account-phone" placeholder="Phone" type="text">
              <input class="optional" id="system-account-phone-alt" placeholder="Alt. Phone" type="text"></td>
          </tr>
          <tr>
            <td><input class="optional" id="system-account-email-alt" placeholder="Alt. Email" type="text"></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2">
              <button id="create-button" onclick="alert('Update User');">&#x02705;<span
                  class="collapsible">&nbsp;Create</span></button>
              <button id="update-button" onclick="alert('Update User');"
                style="display: none;">&#x1F4DD;<span class="collapsible">&nbsp;Update</span></button>
            </td>
          </tr>
        </tfoot>
      </table>
      <p class="note">Login name is required. All other fields are optional.</p>
    </fieldset>

    <fieldset>
      <legend>Bulk Account Creation</legend>
      <input class="large" id="bulk-user-field" placeholder="Login Name(s)" type="text">
      <select>
        <option>Standard User</option>
        <option>Power User</option>
        <option>Admin User</option>
      </select>
      <button onclick="alert('Add User');">&#x02705;<span class="collapsible">
        Create</span></button>
      <p class="note">Separating mulitiple login names with spaces. All accounts will have the same access.</p>
    </fieldset>
  </form>
</body>

</html>