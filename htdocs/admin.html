<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Administration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="hello.css" rel="stylesheet" type="text/css">
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Open up <details> all at once. */
    function openDetails() {
      let elements = document.getElementsByTagName('details');
      for (let i = 0; i < elements.length; i++) {
        elements[i].setAttribute('open', '');
      }
    }

    /*
    * Users
    */

    /* AJAX fetch users */
    function getUsers() {
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let usersObj = JSON.parse(this.responseText);
          let users = Object.keys(usersObj);
          users.sort();
          let enabledList = '';
          let disabledList = '';
          for (let i = 0; i < users.length; i++) {
            if (!usersObj[users[i]].includes('D')) {
              enabledList += '<option>' + users[i] + '</option>';
            }
            else {
              disabledList += '<option>' + users[i] + '</option>';
            }
          }
          document.getElementById('user-enabled').size = Math.min(users.length, 10);
          document.getElementById('user-enabled').innerHTML = enabledList;
          document.getElementById('user-disabled').size = Math.min(users.length, 10);
          document.getElementById('user-disabled').innerHTML = disabledList;
        }
      };
      xhttp.open('GET', './users', true);
      xhttp.send();
    }

    /* AJAX add user(s) */
    function addUsers(userList) {
      if (userList) {
        document.body.style.cursor = 'wait';
        let users = userList.split(' ');
        let xhttp = [];
        for (let i = 0; i < users.length; i++) {
          url = './user/' + users[i];
          xhttp[i] = new XMLHttpRequest();
          xhttp[i].onreadystatechange = function () {
            if (xhttp[i].readyState === 4) {
              document.body.style.cursor = 'default';
              if (xhttp[i].status !== 200) alert('Error: ' + xhttp[i].responseText);
            }
          };
          xhttp[i].open('POST', url, true);
          xhttp[i].send('');
        }
      }
    }

    /* AJAX set user attribute (enable/disable) */
    function setUser(user, attribute) {
      if (user) {
        document.body.style.cursor = 'wait';
        url = './user/' + user + '/' + attribute;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            document.body.style.cursor = 'default';
            if (this.status !== 200) alert('Error: ' + this.responseText);
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* AJAX delete user */
    function delUser(user) {
      if (user) {
        if (confirm('Permanently delete ' + user + '?')) {
          document.body.style.cursor = 'wait';
          url = './user/' + user;
          let xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState === 4) {
              document.body.style.cursor = 'default';
              if (this.status !== 200) alert('Error: ' + this.responseText);
            }
          };
          xhttp.open('DELETE', url, true);
          xhttp.send();
        }
      }
    }

    /*
    * Storage
    */

    /* Human readable disk-size */
    function diskSizeHuman(sizeBytes) {
      let size = sizeBytes;
      let label = ['B', 'K', 'M', 'G', 'T', 'P'];
      let count = 0;
      while (size / 1000 > 1 && count < label.length - 1) {
        size /= 1000;
        count++;
      }
      size = Math.round(size);
      return `${size}${label[count]}`;
    }

    /* AJAX fetch storage devices (disks) */
    function getDisks() {
      let url = './disks';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let disksObj = JSON.parse(this.responseText);
          let disks = Object.keys(disksObj);
          disks.sort();
          let diskList = '';
          for (let i = 0; i < disks.length; i++) {
            diskList += '<option>' + disks[i] + '</option>';
          }
          document.getElementById('storage-devices').innerHTML = diskList;
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX fetch disk label and size */
    function getDiskInfo(disk) {
      let url = './disk/' + disk;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let diskObj = JSON.parse(this.responseText);
          document.getElementById('storage-label').value = '';
          document.getElementById('storage-size').innerHTML = diskSizeHuman(diskObj.size);
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX fetch partitions belonging to a storage device */
    function getPartitions(disk) {
      let url = './disk/' + disk + '/partitions';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let partitionsObj = JSON.parse(this.responseText);
          let partitions = Object.keys(partitionsObj);
          partitions.sort();
          let partitionList = '';
          for (let i = 0; i < partitions.length; i++) {
            partitionList += '<option>' + partitions[i] + '</option>';
          }
          document.getElementById('storage-partitions').innerHTML = partitionList;
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX fetch partition label and size */
    function getPartitionInfo(partition) {
      let url = './partition/' + partition;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let partitionObj = JSON.parse(this.responseText);
          document.getElementById('storage-size').innerHTML = diskSizeHuman(partitionObj.size);
          document.getElementById('storage-label').value = partitionObj.label;
          getFilesystemInfo(partitionObj.label);
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX fetch mounted filesystem info by label */
    function getFilesystemInfo(label) {
      let url = './filesystem/' + label;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let filesystemObj = JSON.parse(this.responseText);
          let e = document.getElementById('storage-mountpoint');
          if (filesystemObj.mountpoint) {
            e.value = filesystemObj.mountpoint;
          }
          else {
            e.value = '';
          }
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX write partition table */
    function writePartitionTable(device) {
      if (confirm('Destroy all data on ' + device + '?')) {

      }
    }

    /* AJAX write filesystem */
    function writeFilesystem(partition) {
      if (confirm('Destroy all data on ' + partition + '?')) {

      }
    }

    /*
    * Service
    */

    /* Get service status and use it to fill element's innerHTML. */
    function getServiceStatus(name, elementId) {
      let url = './system/service/' + name;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) {
            document.getElementById(elementId).innerHTML = JSON.parse(this.responseText);
          }
          else {
            document.getElementById(elementId).innerHTML = "Not running.";
          }
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /*
    * Time
    */

    /* Get server time and browser time, in UTC and to the nearest minute. */
    function getDateTime() {
      let xhttpTime = new XMLHttpRequest();
      xhttpTime.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) {
            let serverDateTime = this.responseText;
            document.getElementById('time-server').value = JSON.parse(serverDateTime);
          }
          else {
            document.getElementById('time-server').value = "yyyy-mm-ddThh:mmZ";
          }
        }
      };
      xhttpTime.open('GET', './datetime', true);
      xhttpTime.send();

      // Report on ntpd service.
      getServiceStatus('ntpd', 'time-ntpd');

      // Create an ISO-8601 date rounded to the nearest minute to match server format.
      let d = new Date();
      let formattedDate = d.getUTCFullYear()
        + '-' + ('0' + (d.getUTCMonth() + 1)).slice(-2)
        + '-' + ('0' + d.getUTCDate()).slice(-2)
        + 'T' + ('0' + d.getUTCHours()).slice(-2)
        + ':' + ('0' + d.getUTCMinutes()).slice(-2)
        + 'Z';
      document.getElementById('time-browser').value = formattedDate;
    }

    /* AJAX fetch mail by message ID. No ID or ID <= 0 will fetch headers.*/
    function getMail(msgNum) {
      if (msgNum === undefined || msgNum < 0) msgNum = 0;
      let url = './system/mail';
      if (msgNum > 0) {
        url += '/' + msgNum;
      }
      url += '/raw';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let mailMsg = this.responseText;
          document.getElementById('mail').value = mailMsg;
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
      mailMsgNum = msgNum;
    }

    /* Current mail message number (0 means show headers only) */
    mailMsgNum = 0;

    /* AJAX log fetcher. */
    function getLog(name) {
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
          let logContents = this.responseText;
          let e = document.getElementById('log-viewer');
          e.value = logContents;
          e.scrollTop = e.scrollHeight;
        }
      };
      xhttp.open('GET', './system/log/' + name + '/raw', true);
      xhttp.send();
    }

    /* Current log file name */
    logFileName = "messages";

  </script>
</head>

<body onload="showHostname();">
  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>

  <nav>
    <p>
      <a href="javascript:openDetails();">Expand All</a>
      |
      <a href="monitor.html">Monitor</a>
    </p>
  </nav>

  <main class="narrow">
    <h2>Administration</h2>

    <!-- User Account Management -->
    <details>
      <summary onclick="getUsers();">&#x1F464; User Accounts</summary>
      <form>
        <table>
          <tr>
            <td><input id='user-list' type="text" size="40em" maxlength="60" pattern="[a-z0-9 ]+"
                placeholder="Lowercase only. Separate with spaces."></td>
            <td><button onclick="addUsers(document.getElementById('user-list').value)" style="color: green"
                type="button">&#x2795;</button>
            </td>
          </tr>
        </table>
        <br>
        <table>
          <tr>
            <th>enabled</th>
            <th></th>
            <th>locked</th>
            <th></th>
          </tr>
          <tr>
            <td><select id="user-enabled" size=5 style="width: 10em;"></select></td>
            <td><button class="narrow"
                onclick="setUser(document.getElementById('user-enabled').value, 'disabled'); getUsers();" type="button"
                title="lock">&#x1F512;&#x276F;</button>
              <br>
              <button class="narrow"
                onclick="setUser(document.getElementById('user-disabled').value, 'enabled'); getUsers();" type="button"
                title="unlock">&#x276E;&#x1F513;</button>
            </td>
            <td><select id="user-disabled" size=5 style="width: 10em;"></select></td>
            <td><button onclick="delUser(document.getElementById('user-disabled').value); getUsers();" type="button"
                title="delete">&#x274C;</button></td>
          </tr>
        </table>
      </form>
    </details>
    </div>

    <!-- Storage Management -->
    <div>
      <details>
        <summary onclick="getDisks();">&#x1F4BE; Storage Devices</summary>
        <form>
          <table>
            <tr>
              <th>device</th>
              <th>partition</th>
              <th>mount</th>
            </tr>
            <tr>
              <td><select id="storage-devices"
                  onchange="document.getElementById('storage-mountpoint').value = ''; e=document.getElementById('storage-devices'); getDiskInfo(e.options[e.selectedIndex].value); getPartitions(e.options[e.selectedIndex].value);"
                  size=5 style="width: 10em;"></select></td>
              <td><select id="storage-partitions"
                  onchange="document.getElementById('storage-mountpoint').value = ''; e=document.getElementById('storage-partitions'); getPartitionInfo(e.options[e.selectedIndex].value);"
                  size=5 style="width: 10em;"></select></td>
              <td style="vertical-align: top;">
                device:<br>
                <input id="storage-label" placeholder="device name" style="width: 10em;"><br>
                mountpoint:<br>
                <input id="storage-mountpoint" placeholder="directory path" style="width: 10em;">
              </td>
            </tr>
            <tr>
              <td><button id="storage-repartition" class="wide" onclick="e=document.getElementById('storage-devices'); writePartitionTable(e.options[e.selectedIndex].value);"
                  title="Write GUID partition table onto selected device."
                  type="button">&#x1F4CB;&#x0279C;&#x1F4BE;</button></td>
              <td><button id="storage-format" class="wide" onclick="e=document.getElementById('storage-partitions'); writeFilesystem(e.options[e.selectedIndex].value);"
                  title="Write UFS filesystem onto selected partition."
                  type="button">&#x1F4DD;&#x0279C;&#x1F4BE;</button></td>
              <td><button id="storage-mount" class="wide" title="Mount filesystem on directory."
                  type="button">&#x1F4BE;&#x0279C;&#x1F4BB;</button></td>
            </tr>
          </table>
          <table>
            <tr>
              <td>Size:</td>
              <td id="storage-size"></td>
            </tr>
          </table>
        </form>
      </details>
    </div>

    <!-- System Date and Time -->
    <div>
      <details>
        <summary onclick="getDateTime();">&#x0231A; System Date-Time</summary>
        <form>
          <table>
            <tr>
              <td><label>Sync:</label></td>
              <td id="time-ntpd"></td>
              <td></td>
            </tr>
            <tr>
              <td><label>Server:</label></td>
              <td><input id="time-server" style="width: 15em;"></td>
              <td><button onclick="getDateTime();" title="Refresh Time" type="button">&#x21BB;</button></td>
            </tr>
            <tr>
              <td><label>Client:</label></td>
              <td><input id="time-browser" readonly style="width: 15em;"></td>
              <td><button title="Reset server time to client time." type="button">&#x0231A;</button></td>
            </tr>
          </table>
        </form>
      </details>
    </div>
  </main>

  <!-- Logs and Email -->
  <aside class="wide">
    <h2>Logs &amp; Messages</h2>
    <details>
      <summary onclick="getLog(logFileName);">&#x1F4C4; Log Viewer</summary>
      <p>
        <button onclick="getLog(logFileName = 'messages');" type="button">system</button>
        <button onclick="getLog(logFileName = 'smbd');" type="button">smbd</button>
        <button onclick="getLog(logFileName = 'nmbd');" type="button">nmbd</button>
        <button onclick="getLog(logFileName = 'messages');" type="button">cron</button>
        <button onclick="getLog(logFileName = 'weenas');" type="button">api</button>
        <button onclick="getLog(logFileName);" title="Refresh Log" type="button">&#x21BB;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="log-viewer"></textarea>
    </details>
    <details>
      <summary onclick="getMail();">&#x1F4E7; System Mail</summary>
      <p>
        <button onclick="getMail(0);" title="Header View" type="button">&#x1F4D1;</button>
        <button onclick="mailMsgNum = Math.max(--mailMsgNum, 0); getMail(mailMsgNum);" title="Previous Message"
          type="button">&#x25B2;</button>
        <button onclick="getMail(++mailMsgNum);" title="Next Message" type="button">&#x25BC;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="mail"></textarea>
    </details>
  </aside>

  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank" style="color: whitesmoke;">WeeNAS = Raspberry
        Pi + Flash Drive + FreeBSD + Samba</a></p>
  </footer>
</body>

</html>