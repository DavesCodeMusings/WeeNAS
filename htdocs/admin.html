<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Administration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="monitor.css" rel="stylesheet" type="text/css">
  <style>
    details {
      padding-bottom: 1em;
    }

    main {
      float: left;
      margin-right: 2em;
      width: 50%;
    }

    main details,
    main summary {
      width: 600px;
    }

    aside {
      float: left;
      margin-left: 1em;
      width: 40%;
    }

    aside details,
    aside summary {
      width: 300px;
    }

    button {
      width: 4em;
    }
  </style>
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Open up <details> all at once. */
    function openDetails() {
      let elements = document.getElementsByTagName('details');
      for (let i = 0; i < elements.length; i++) {
        elements[i].setAttribute('open', '');
      }
    }

    /* AJAX user fetcher. */
    function getUsers() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let userFlags = JSON.parse(this.responseText);
          let users = Object.keys(userFlags);
          let enabledCount = 0;
          let enabledList = '';
          let disabledList = '';
          for (let i = 0; i < users.length; i++) {
            if (!userFlags[users[i]].includes('D')) {
              enabledList += '<option>' + users[i] + '</option>';
              enabledCount++;
            }
            else {
              disabledList += '<option>' + users[i] + '</option>';
            }
          }
          document.getElementById('user-total').innerHTML = ' (' + enabledCount + ' active)';
          document.getElementById('user-enabled').size = Math.max(users.length, 5);
          document.getElementById('user-enabled').innerHTML = enabledList;
          document.getElementById('user-disabled').size = Math.max(users.length, 5);
          document.getElementById('user-disabled').innerHTML = disabledList;
        }
      };
      xhttp.open('GET', './users/flags', true);
      xhttp.send();
    }

    /* AJAX mail fetcher. */
    function getMail(msgNum) {
      let url = './system/mail';
      if (typeof(msgNum) === 'number') url += '/' + msgNum;
      url += '/raw';
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let mailMsg = this.responseText;
          document.getElementById('mail').value = mailMsg;
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX log fetcher. */
    function getLog(name) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let logContents = this.responseText;
          document.getElementById(name).value = logContents;
        }
      };
      xhttp.open('GET', './system/log/' + name + '/raw', true);
      xhttp.send();
    }

    /* Current Mail Message Number */
    mailMsgNum = 1;
  </script>
</head>

<body onload="showHostname(); getUsers(); getMail(); getLog('messages'); getLog('smbd'); getLog('nmbd'); getLog('weenas');">
  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>
  <nav>
    <p>
      <a href="javascript:openDetails();">Expand All</a>
      |
      <a href="monitor.html">Monitor</a>
    </p>
  </nav>
  <main>
    <h2>Logs &amp; Messages</h2>
    <details open>
      <summary>/var/log/messages</summary>
      <textarea rows=25 cols=80  id="messages"></textarea>
      <button onclick="getLog('messages');" type="button">&#x21BB;</button>
    </details>
    <details>
      <summary>/var/log/samba4/smbd.log</summary>
      <textarea rows=25 cols=80  id="smbd"></textarea>
      <button onclick="getLog('smbd');" type="button">&#x21BB;</button>
    </details>
    <details>
      <summary>/var/log/samba4/nmbd.log</summary>
      <textarea rows=25 cols=80  id="nmbd"></textarea>
      <button onclick="getLog('nmbd');" type="button">&#x21BB;</button>
    </details>
    <details>
      <summary>/var/log/weenas_api.log</summary>
      <textarea rows=25 cols=80  id="weenas"></textarea>
      <button onclick="getLog('weenas');" type="button">&#x21BB;</button>
    </details>
    <details>
      <summary>System Mail</summary>
      <textarea rows=25 cols=80 id="mail"></textarea>
      <button onclick="getMail(); mailMsgNum = 1;" title="Reload Headers" type="button">&#x21BB;</button>
      <button onclick="getMail(mailMsgNum);" title="Switch to Message View" type="button">&#x1F4C4;</button>
      <button onclick="mailMsgNum = Math.max(--mailMsgNum, 1); getMail(mailMsgNum);" title="Previous Message" type="button">&#x25B2;</button>
      <button onclick="getMail(++mailMsgNum);" title="Next Message" type="button">&#x25BC;</button>
    </details>
  </main>
  <aside>
    <h2>Administration</h2>
    <details open>
      <summary>Add Users</summary>
      <form>
        <table>
          <tr>
            <td><input type="text" size="50em"></td>
            <td><button type="submit" style="color: green; width: 4em;" type="submit">&#x2714;</button></td>
          </tr>
        </table>
      </form>
      <p>Separate account names with spaces.</p>
    </details>
    <div>
      <details open>
        <summary>Current Accounts <span id="user-total"></span></summary>
          <form>
            <table>
              <tr>
                <td><select id="user-enabled" size=5 style="width: 10em;"></select></td>
                <td><button type="button" style="width: 4em;" title="lock">&#x1F512;&#x276F;</button>
                  <br>
                  <button type="button" style="width: 4em;" title="unlock">&#x276E;&#x1F513;</button>
                </td>
                <td><select id="user-disabled" size=5 style="width: 10em;"></select></td>
                <td><button onclick="alert('Are you sure?');"type="button" style="width: 4em;" title="delete">&#x274C;</button></td>
              </tr>
            </table>
          </form>
      </details>
    </div>
    <div>
      <details>
        <summary>Filesystems</summary>
      </details>
    </div>
    <div>
      <details>
        <summary>System Time</summary>
      </details>
    </div>
  </aside>
  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank" style="color: whitesmoke;">WeeNAS = Raspberry
        Pi + Flash Drive + FreeBSD + Samba</a></p>
  </footer>
</body>

</html>