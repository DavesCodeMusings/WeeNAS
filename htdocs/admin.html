<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Administration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="hello.css" rel="stylesheet" type="text/css">
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Open up <details> all at once. */
    function openDetails() {
      let elements = document.getElementsByTagName('details');
      for (let i = 0; i < elements.length; i++) {
        elements[i].setAttribute('open', '');
      }
    }

    /*
    * Users
    */

    /* Display user accounts, separating into enanbled/disabled on the page. */
    function updateUserList(usersObj) {
      let users = Object.keys(usersObj);
      users.sort();
      let enabledList = '';
      let disabledList = '';
      for (let i = 0; i < users.length; i++) {
        if (!usersObj[users[i]].includes('D')) {
          enabledList += '<option>' + users[i] + '</option>';
        }
        else {
          disabledList += '<option>' + users[i] + '</option>';
        }
      }
      document.getElementById('user-enabled').innerHTML = enabledList;
      document.getElementById('user-disabled').innerHTML = disabledList;
    }

    /* AJAX fetch users */
    function getUsers(callback) {
      url = './users';
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          else alert('ERROR: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX add user(s) */
    function addUsers(userList) {
      if (userList) {
        document.body.style.cursor = 'wait';
        let users = userList.split(' ');
        let xhttp = [];
        for (let i = 0; i < users.length; i++) {
          url = './user/' + users[i];
          xhttp[i] = new XMLHttpRequest();
          xhttp[i].onreadystatechange = function () {
            if (xhttp[i].readyState === 4) {
              if (xhttp[i].status !== 200) alert('Error: ' + xhttp[i].responseText);
              document.body.style.cursor = 'default';
            }
          };
          xhttp[i].open('POST', url, true);
          xhttp[i].send('');
        }
      }
    }

    /* AJAX set user attribute (enable/disable) */
    function setUser(user, attribute) {
      if (user) {
        document.body.style.cursor = 'wait';
        url = './user/' + user + '/' + attribute;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status !== 200) alert('Error: ' + this.responseText);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* AJAX delete user */
    function delUser(user) {
      if (user) {
        if (confirm('Permanently delete ' + user + '?')) {
          document.body.style.cursor = 'wait';
          url = './user/' + user;
          let xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState === 4) {
              if (this.status !== 200) alert('Error: ' + this.responseText);
              document.body.style.cursor = 'default';
            }
          };
          xhttp.open('DELETE', url, true);
          xhttp.send();
        }
      }
    }

    /*
    * Storage
    */

    /* Human readable disk-size */
    function diskSizeHuman(sizeBytes) {
      let size = sizeBytes;
      let label = ['B', 'K', 'M', 'G', 'T', 'P'];
      let count = 0;
      while (size / 1000 > 1 && count < label.length - 1) {
        size /= 1000;
        count++;
      }
      size = Math.round(size);
      return `${size}${label[count]}`;
    }

    /* Display disk information */
    function updateDiskList(disksObj) {
      let diskNames = Object.keys(disksObj);
      diskNames.sort();
      let diskOptionList = '';
      for (let i = 0; i < diskNames.length; i++) {
        diskOptionList += '<option>' + diskNames[i] + '</option>';
      }
      document.getElementById('storage-devices').innerHTML = diskOptionList;
    }

    /* AJAX fetch storage devices (disks) */
    function getDisks(callback) {
      let url = './disks';
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Display partition information */
    function updateDiskInfo(diskObj) {
      let partitionNames = Object.keys(diskObj.partitions);
      partitionNames.sort();
      let partitionOptionList = '';
      for (let i = 0; i < partitionNames.length; i++) {
        partitionOptionList += '<option>' + partitionNames[i] + '</option>';
      }
      document.getElementById('storage-partitions').innerHTML = partitionOptionList;
      if (diskObj.size) document.getElementById('storage-size').innerHTML = diskSizeHuman(diskObj.size);
      if (diskObj.description) document.getElementById('storage-description').innerHTML = diskObj.description;
    }

    /* Get information about a particular disk. */
    function getDiskInfo(disk, callback) {
      let url = './disk/' + disk;
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Display available filesystems */
    function updateFilesystems(filesystemsArr) {
      filesystemsList = '';
      for (let i = 0; i < filesystemsArr.length; i++) {
        filesystemsList += '<option>' + filesystemsArr[i] + '</option>'
        document.getElementById('storage-filesystems').innerHTML = filesystemsList;
      }
    }

    /* AJAX fetch available filesystems */
    function getFilesystems(fsType, callback) {
      let url = './filesystems/' + fsType;
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Display mountpoint */
    function updateMountpoint(directory, editable) {
      let e = document.getElementById('storage-mountpoint')
      e.value = directory;
      if (editable) e.removeAttribute('readonly');
      else e.setAttribute('readonly', true);
    }

    /* Determine a default mount directory based on filesystem label */
    function suggestMountPoint(fsLabel, callback) {
      let mountpoint = '';
      let editable = false;
      if (fsLabel == "rootfs") {
        mountpoint = '/';
      }
      else if (fsLabel == "homefs") {
        mountpoint = '/home';
      }
      else {
        // Chop 'fs' off the end for readability, so 'musicfs' becomes 'music'.
        if (fsLabel.substring(fsLabel.length - 2) == 'fs') {
          fsLabel = fsLabel.substring(0, fsLabel.length - 2);
        }
        mountpoint = '/media/' + fsLabel;
        editable = true;
      }
      callback(mountpoint, editable);
    }

    /* AJAX write partition scheme */
    function formatDisk(disk) {
      if (confirm('This will destroy all data on ' + disk)) {
        document.body.style.cursor = 'wait';
        let url = './disk/' + disk + '/gpt';
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              reply = JSON.parse(this.responseText);
              alert(reply);
            }
            else alert('Error writing partition scheme to ' + disk);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* AJAX write filesystem */
    function writeFilesystem(partition) {
      if (confirm('This will destroy all data on ' + partition)) {
        document.body.style.cursor = 'wait';
        let url = './disk/' + partition + '/ufs';
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              reply = JSON.parse(this.responseText);
              alert(reply);
            }
            else alert('Error writing filesystem to ' + partition);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /*
    * Services
    */

    /* Display ntpd Status */
    function updateNtpd(status) {
      document.getElementById('time-ntpd').innerHTML = status;
    }

    /* Get service status. */
    function getServiceStatus(name, callback) {
      let url = './system/service/' + name;
      let xhttp = new XMLHttpRequest();
      document.body.style.cursor = 'wait';
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
        }
        document.body.style.cursor = 'default';
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /*
    * Time
    */

    /* Display date and time */
    function updateDateTime(dateTimeString) {
      document.getElementById('time-server').value = dateTimeString;

      // Create an ISO-8601 date rounded to the nearest minute to match server format.
      let d = new Date();
      let formattedDate = d.getUTCFullYear()
        + '-' + ('0' + (d.getUTCMonth() + 1)).slice(-2)
        + '-' + ('0' + d.getUTCDate()).slice(-2)
        + 'T' + ('0' + d.getUTCHours()).slice(-2)
        + ':' + ('0' + d.getUTCMinutes()).slice(-2)
        + 'Z';
      document.getElementById('time-client').value = formattedDate;
    }

    /* Get server time and browser time, in UTC and to the nearest minute. */
    function getDateTime(callback) {
      let xhttpTime = new XMLHttpRequest();
      document.body.style.cursor = 'wait';
      xhttpTime.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
        }
        document.body.style.cursor = 'default';
      };
      xhttpTime.open('GET', './datetime', true);
      xhttpTime.send();
    }

    /* Current log file name */
    logFileName = "messages";

    /* Display log contents and automaticall scroll down to most recent events. */
    function updateLog(contents) {
      let e = document.getElementById('log-viewer');
      e.value = contents;
      e.scrollTop = e.scrollHeight;
    }

    /* AJAX log fetcher. */
    function getLog(name, callback) {
      let url = './system/log/' + name + '/raw';
      let xhttp = new XMLHttpRequest();
      document.body.style.cursor = 'wait';
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) callback(this.responseText);
          else alert('Error: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /*
    *  Mail
    */

    /* Current mail message number (0 means show headers only) */
    mailMsgNum = 0;

    /* Display contents of mail message or headers. */
    function updateMail(msg) {
      document.getElementById('mail').value = msg;
    }

    /* AJAX fetch mail by message ID. No ID or ID <= 0 will fetch headers.*/
    function getMail(msgNum, callback) {
      if (msgNum === undefined || msgNum < 0) msgNum = 0;
      let url = './system/mail';
      if (msgNum > 0) {
        url += '/' + msgNum;
      }
      url += '/raw';
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(this.responseText);
          else alert(this.responseText);
          mailMsgNum = msgNum;
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* AJAX delete mail by message ID. */
    function delMail(msgNum) {
      if (typeof (msgNum) == 'number' && msgNum > 0) {
        let url = './system/mail/' + msgNum;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4 && this.status !== 200) {
            alert("Mail delete failed.")
          }
        };
        xhttp.open('DELETE', url, true);
        xhttp.send();
      }
    }
  </script>
</head>

<body onload="showHostname();">
  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>

  <nav>
    <p>
      <a href="javascript:openDetails();">Expand All</a>
      |
      <a href="monitor.html">Monitor</a>
    </p>
  </nav>

  <main class="narrow">
    <h2>Administration</h2>

    <!-- User Account Management -->
    <details>
      <summary>&#x1F464; User Accounts</summary>
      <div style="margin-left: 1em;">
        <details>
          <summary>&#x02795; Add</summary>
          <form>
            <table>
              <tr>
                <td><input id='user-list' type="text" size="35em" maxlength="60" pattern="[a-z0-9 ]+"
                    placeholder="Lowercase; separate with spaces."></td>
                <td><button class="narrow" onclick="addUsers(document.getElementById('user-list').value)" type="button">
                    <span style="color: green; font-size: 125%; font-weight: bold;">+</span></button>
                </td>
              </tr>
            </table>
          </form>
        </details>
        <details>
          <summary onclick="getUsers(updateUserList);">&#x1F527; Manage</summary>
          <form>
            <table>
              <tr>
                <th>enabled</th>
                <th>locked</th>
              </tr>
              <tr>
                <td><select id="user-enabled" size=5 style="width: 10em;"></select></td>
                <td><select id="user-disabled" size=5 style="width: 10em;"></select></td>
              </tr>
              <tr>
                <td><button class="wide"
                  onclick="setUser(document.getElementById('user-enabled').value, 'disabled'); getUsers(updateUserList);"
                  type="button" title="Lock account">&#x1F512;&#x0276F;</button>
                </td>
                <td><button onclick="setUser(document.getElementById('user-disabled').value, 'enabled'); getUsers(updateUserList);"
                  type="button" title="Unlock account">&#x0276E;&#x1F513;</button>
                  <button class="narrow"
                    onclick="delUser(document.getElementById('user-disabled').value); getUsers(updateUserList);"
                    type="button" title="Delete account">&#x0274C</button>
                </td>
              </tr>
            </table>
          </form>
        </details>
      </div>
    </details>

    <!-- Storage Management -->

    <details>
      <summary>&#x1F4BE; Storage Devices</summary>
      <div style="margin-left: 1em;">
        <details>
          <summary onclick="getDisks(updateDiskList);">&#x02795; Add</summary>
          <form>
            <table>
              <tr>
                <th>device</th>
                <th>partition</th>
              </tr>
              <tr>
                <td><select id="storage-devices"
                    onchange="e=document.getElementById('storage-devices'); getDiskInfo(e.options[e.selectedIndex].value, updateDiskInfo);"
                    size=4 style="width: 10em;"></select></td>
                <td><select id="storage-partitions" size=3 style="width: 10em;"></select><br>
                  <input placeholder="filesystem label" style="width: 10em;"></td>
              </tr>
              <tr>
                <td><button class="wide" onclick="e=document.getElementById('storage-devices'); formatDisk(e.options[e.selectedIndex].value);"
                    title="Create FreeBSD partition and filesystem." type="button">&#x1F4CB;&#x0279C;&#x1F4BE;</button></td>
                <td><button class="wide" onclick="e=document.getElementById('storage-partitions'); writeFilesystem(e.options[e.selectedIndex].value);"
                    title="Write filesystem label onto selected partition." type="button">&#x1F4DD;&#x0279C;&#x1F4BE;</button></td>
            </table>
            <table>
              <tr>
                <td>Name:</td>
                <td id="storage-description"></td>
              </tr>
              <tr>
                <td>Size:</td>
                <td id="storage-size"></td>
              </tr>
            </table>
          </form>
        </details>

        <!-- Management of existing filesystems. (Mounting) -->
        <details>
          <summary onclick="getFilesystems('ufs', updateFilesystems); document.getElementById('storage-mountpoint').value ='';">&#x1F527; Manage</summary>
          <form>
            <table>
              <tr>
                <th>filesystem</th>
                <th>directory</th>
              </tr>
              <tr>
                <td><select id='storage-filesystems'
                    onchange="e=document.getElementById('storage-filesystems'); suggestMountPoint(e.options[e.selectedIndex].value, updateMountpoint);"
                    size=4 style="width: 10em;"></select></td>
                <td style="vertical-align: top"><input id="storage-mountpoint" readonly style="width: 10em;" type="text"><br>
              </tr>
                <td>
                  <button id="storage-mount" class="wide" title="Mount filesystem on directory." type="button">&#x1F4BE;&#x276F; &#x1F4BB;</button>
                </td>
                <td>
                  <button id="storage-mount" class="wide" title="Unmount filesystem." type="button">&#x276E;&#x1F4BE; &#x1F4BB;</button>
                </td>
              </tr>
            </table>
          </form>
        </details>
      </div>
    </details>

    <!-- System Date and Time -->
    <details>
      <summary onclick="getDateTime(updateDateTime); getServiceStatus('ntpd', updateNtpd);">&#x0231A; System Date-Time
      </summary>
      <div style="margin-left: 1em;">
        <form>
          <table>
            <tr>
              <td><label>Sync:</label></td>
              <td id="time-ntpd"></td>
              <td></td>
            </tr>
            <tr>
              <td><label>Server:</label></td>
              <td><input id="time-server" style="width: 15em;"></td>
              <td><button onclick="getDateTime(updateDateTime); getServiceStatus('ntpd', updateNtpd);" title="Refresh Time" type="button">&#x21BB;</button></td>
            </tr>
            <tr>
              <td><label>Client:</label></td>
              <td><input id="time-client" readonly style="width: 15em;"></td>
              <td><button title="Reset server time to client time." type="button">&#x0231A;</button></td>
            </tr>
          </table>
        </form>
      </div>
    </details>
  </main>

  <!-- Logs and Email -->
  <aside class="wide">
    <h2>Logs &amp; Messages</h2>
    <details>
      <summary onclick="getLog(logFileName, updateLog);">&#x1F4C4; Log Viewer</summary>
      <p>
        <button onclick="getLog(logFileName = 'messages', updateLog);" type="button">system</button>
        <button onclick="getLog(logFileName = 'smbd', updateLog);" type="button">smbd</button>
        <button onclick="getLog(logFileName = 'nmbd', updateLog);" type="button">nmbd</button>
        <button onclick="getLog(logFileName = 'cron', updateLog);" type="button">cron</button>
        <button onclick="getLog(logFileName = 'weenas', updateLog);" type="button">api</button>
        <button onclick="getLog(logFileName, updateLog);" title="Refresh Log" type="button">&#x21BB;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="log-viewer"></textarea>
    </details>
    <details>
      <summary onclick="getMail(0, updateMail);">&#x1F4E7; System Mail</summary>
      <p>
        <button onclick="getMail(0,updateMail);" title="Header View" type="button">&#x1F4D1;</button>
        <button onclick="mailMsgNum = Math.max(--mailMsgNum, 0); getMail(mailMsgNum, updateMail);"
          title="Previous Message" type="button">&#x25B2;</button>
        <button onclick="getMail(++mailMsgNum, updateMail);" title="Next Message" type="button">&#x25BC;</button>
        <button onclick="delMail(mailMsgNum); getmail(0, updateMail);" title="Delete Message"
          type="button">&#x274C;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="mail"></textarea>
    </details>
  </aside>

  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank" style="color: whitesmoke;">WeeNAS = Raspberry
        Pi + Flash Drive + FreeBSD + Samba</a></p>
  </footer>
</body>

</html>