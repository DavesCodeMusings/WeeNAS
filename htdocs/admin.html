<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Administration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="hello.css" rel="stylesheet" type="text/css">
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Open up <details> all at once. */
    function openDetails() {
      let elements = document.getElementsByTagName('details');
      for (let i = 0; i < elements.length; i++) {
        elements[i].setAttribute('open', '');
      }
    }

    /* AJAX fetch users */
    function getUsers() {
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let userFlags = JSON.parse(this.responseText);
          let users = Object.keys(userFlags);
          let enabledList = '';
          let disabledList = '';
          for (let i = 0; i < users.length; i++) {
            if (!userFlags[users[i]].includes('D')) {
              enabledList += '<option>' + users[i] + '</option>';
            }
            else {
              disabledList += '<option>' + users[i] + '</option>';
            }
          }
          document.getElementById('user-total').innerHTML = users.length;
          document.getElementById('user-enabled').size = Math.min(users.length, 10);
          document.getElementById('user-enabled').innerHTML = enabledList;
          document.getElementById('user-disabled').size = Math.min(users.length, 10);
          document.getElementById('user-disabled').innerHTML = disabledList;
        }
      };
      xhttp.open('GET', './users/flags', true);
      xhttp.send();
    }

    /* AJAX add user(s) */
    function addUsers(userList) {
      if (userList) {
        document.body.style.cursor = 'wait';
        let users = userList.split(' ');
        let xhttp = [];
        for (let i = 0; i < users.length; i++) {
          url = './user/' + users[i];
          xhttp[i] = new XMLHttpRequest();
          xhttp[i].onreadystatechange = function () {
            if (xhttp[i].readyState === 4) {
              document.body.style.cursor = 'default';
              if (xhttp[i].status !== 200) alert('Error: ' + xhttp[i].responseText);
            }
          };
          xhttp[i].open('POST', url, true);
          xhttp[i].send('');
        }
      }
    }

    /* AJAX set user attribute (enable/disable) */
    function setUser(user, attribute) {
      if (user) {
        document.body.style.cursor = 'wait';
        url = './user/' + user + '/' + attribute;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            document.body.style.cursor = 'default';
            if (this.status !== 200) alert('Error: ' + this.responseText);
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* AJAX delete user */
    function delUser(user) {
      if (user) {
        if (confirm('Permanently delete ' + user + '?')) {
          document.body.style.cursor = 'wait';
          url = './user/' + user;
          let xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState === 4) {
              document.body.style.cursor = 'default';
              if (this.status !== 200) alert('Error: ' + this.responseText);
            }
          };
          xhttp.open('DELETE', url, true);
          xhttp.send();
        }
      }
    }

    /* Get service status and use it to fill element's innerHTML. */
    function getServiceStatus(name, elementId) {
      let url = './system/service/' + name;
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) {
            document.getElementById(elementId).innerHTML = JSON.parse(this.responseText);
          }
          else {
            document.getElementById(elementId).innerHTML = "Not running.";
          }
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Get server time and browser time, in UTC and to the nearest minute. */
    function getDateTime() {
      let xhttpTime = new XMLHttpRequest();
      xhttpTime.onreadystatechange = function () {
        if (this.readyState === 4) {
          if (this.status === 200) {
            let serverDateTime = this.responseText;
            document.getElementById('time-server').value = JSON.parse(serverDateTime);
          }
          else {
            document.getElementById('time-server').value = "yyyy-mm-ddThh:mmZ";
          }
        }
      };
      xhttpTime.open('GET', './datetime', true);
      xhttpTime.send();

      // Report on ntpd service.
      getServiceStatus('ntpd', 'time-ntpd');

      // Create an ISO-8601 date rounded to the nearest minute to match server format.
      let d = new Date();
      let formattedDate = d.getUTCFullYear()
        + '-' + ('0' + (d.getUTCMonth() + 1)).slice(-2)
        + '-' + ('0' + d.getUTCDate()).slice(-2)
        + 'T' + ('0' + d.getUTCHours()).slice(-2)
        + ':' + ('0' + d.getUTCMinutes()).slice(-2)
        + 'Z';
      document.getElementById('time-browser').value = formattedDate;
    }

    /* AJAX fetch mail by message ID. No ID or ID=0 will fetch headers.*/
    function getMail(msgNum) {
      let url = './system/mail';
      if (typeof (msgNum) === 'number' && msgNum > 0) url += '/' + msgNum;
      else mailMsgNum = 0;
      url += '/raw';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          let mailMsg = this.responseText;
          document.getElementById('mail').value = mailMsg;
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Current mail message number */
    mailMsgNum = 0;

    /* AJAX log fetcher. */
    function getLog(name) {
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
          let logContents = this.responseText;
          let e = document.getElementById('log-viewer');
          e.value = logContents;
          e.scrollTop = e.scrollHeight;
        }
      };
      xhttp.open('GET', './system/log/' + name + '/raw', true);
      xhttp.send();
    }

    /* Current log file name */
    logFileName = "messages";

  </script>
</head>

<body onload="showHostname();">
  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>

  <nav>
    <p>
      <a href="javascript:openDetails();">Expand All</a>
      |
      <a href="monitor.html">Monitor</a>
    </p>
  </nav>

  <main class="narrow">
    <h2>Administration</h2>
    <details>
      <summary>&#x1F464;&#x2795; Add User Accounts</summary>
      <form>
        <table>
          <tr>
            <td><input id='user-list' type="text" size="40em" maxlength="60" pattern="[a-z0-9 ]+"
                placeholder="Lowercase only. Separate with spaces."></td>
            <td><button onclick="addUsers(document.getElementById('user-list').value)" style="color: green"
                type="button">&#x2714;</button>
            </td>
          </tr>
        </table>
      </form>
    </details>
    <div>
      <details>
        <summary onclick="getUsers();">&#x1F464;&#x1F4CB; Manage Account Properties</summary>
        <form>
          <table>
            <tr>
              <td><select id="user-enabled" size=5 style="width: 10em;"></select></td>
              <td><button onclick="setUser(document.getElementById('user-enabled').value, 'disabled'); getUsers();"
                  type="button" title="lock">&#x1F512;&#x276F;</button>
                <br>
                <button onclick="setUser(document.getElementById('user-disabled').value, 'enabled'); getUsers();"
                  type="button" title="unlock">&#x276E;&#x1F513;</button>
              </td>
              <td><select id="user-disabled" size=5 style="width: 10em;"></select></td>
              <td><button onclick="delUser(document.getElementById('user-disabled').value); getUsers();" type="button"
                  title="delete">&#x274C;</button></td>
            </tr>
          </table>
          <p>Total users: <span id="user-total"></span></p>
        </form>
      </details>
    </div>
    <div>
      <details>
        <summary onclick="getDateTime();">&#x1F4C5;&#x0231A; System Date-Time</summary>
        <form>
          <table>
            <tr>
              <td><label>Sync:</label></td>
              <td id="time-ntpd"></td>
              <td></td>
            </tr>
            <tr>
              <td><label>Server:</label></td>
              <td><input id="time-server" style="width: 15em;"></td>
              <td><button title="Reset server time to client time." type="button">&#x027A5; &#x0231A;</button></td>
            </tr>
            <tr>
              <td><label>Client:</label></td>
              <td><input id="time-browser" readonly style="width: 15em;"></td>
              <td><button onclick="getDateTime();" title="Refresh Time" type="button">&#x21BB;</button></td>
            </tr>
          </table>
        </form>
      </details>
    </div>
  </main>

  <aside>
    <h2>Logs &amp; Messages</h2>
    <details>
      <summary onclick="getLog(logFileName);">&#x1F4C4; Log Viewer</summary>
      <p>
        <button onclick="getLog(logFileName = 'messages');" type="button">system</button>
        <button onclick="getLog(logFileName = 'smbd');" type="button">smbd</button>
        <button onclick="getLog(logFileName = 'nmbd');" type="button">nmbd</button>
        <button onclick="getLog(logFileName = 'weenas');" type="button">api</button>
        <button onclick="getLog(logFileName);" title="Refresh Log" type="button">&#x21BB;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="log-viewer"></textarea>
    </details>
    <details>
      <summary onclick="getMail();">&#x1F4E7; System Mail</summary>
      <p>
        <button onclick="getMail(0);" title="Header View" type="button">&#x2709;</button>
        <button onclick="mailMsgNum = Math.max(--mailMsgNum, 0); getMail(mailMsgNum);" title="Previous Message"
          type="button">&#x25B2;</button>
        <button onclick="getMail(++mailMsgNum);" title="Next Message" type="button">&#x25BC;</button>
      </p>
      <textarea readonly rows=25 cols=80 id="mail"></textarea>
    </details>
  </aside>

  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank" style="color: whitesmoke;">WeeNAS = Raspberry
        Pi + Flash Drive + FreeBSD + Samba</a></p>
  </footer>
</body>

</html>