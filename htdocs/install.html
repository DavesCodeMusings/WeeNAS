<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Initial Configuration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link id="page-style" href="hello.css" rel="stylesheet" type="text/css">

  <script src="tzNamesLib.js"></script>
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Change the visibility of DIV elements as focus on input areas is changed. */
    function toggleBlurb(elementId) {
      document.getElementById('general-blurb').style.display = 'none';
      document.getElementById('trusted-user-blurb').style.display = 'none';
      document.getElementById('hostname-blurb').style.display = 'none';
      document.getElementById('timezone-blurb').style.display = 'none';
      document.getElementById('storage-blurb').style.display = 'none';
      document.getElementById('finalizing-blurb').style.display = 'none';
      document.getElementById(elementId).style.display = 'block';
    }

    /* Authorization */
    var authHeader = '';

    /* Indicate that credentials were entered (correctly?) */
    function credentialsEntered() {
      document.getElementById('credentials-key').style.opacity = '1.0';
      document.getElementById('credentials').removeAttribute('open');
    }

    /* Create authorization header from credentials */
    function createAuth(username, password, callback) {
      authHeader = 'Basic ' + btoa(username + ':' + password);
      callback();
    }

    /* AJAX set user attribute (lock/unlock, trusted/untrusted) */
    function setUser(user, attribute) {
      if (user) {
        document.body.style.cursor = 'wait';
        url = './user/' + user + '/' + attribute;
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status !== 200) alert('Error: ' + this.responseText);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* API call to add user(s) */
    function addUsers(userList) {
      if (userList) {
        document.body.style.cursor = 'wait';
        let users = userList.split(' ');
        let xhttp = [];
        for (let i = 0; i < users.length; i++) {
          url = './user/' + users[i];
          xhttp[i] = new XMLHttpRequest();
          xhttp[i].onreadystatechange = function () {
            if (xhttp[i].readyState === 4) {
              if (xhttp[i].status == 200) setUser(users[i], 'trusted');
              else alert('Error: ' + xhttp[i].responseText);
              document.body.style.cursor = 'default';
            }
          };
          xhttp[i].open('POST', url, true);
          xhttp[i].send('');
        }
      }
    }

    /* API call to set the hostname. */
    function setHostname(host, domain) {
      if (host) {
        let hostname = host;
        if (domain) hostname += '.' + domain;
        let url = './system/hostname/' + hostname;
        document.body.style.cursor = 'wait';
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status != 200) alert('Error: ' + this.responseText);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* API call to set the timezone. */
    function setTimezone(area, location) {
      if (area && location) {
        let url = './system/timezone/' + area + '/' + location;
        document.body.style.cursor = 'wait';
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status != 200) alert('Error: ' + this.responseText);
            document.body.style.cursor = 'default';
          }
        };
        xhttp.open('PUT', url, true);
        xhttp.send();
      }
    }

    /* Human readable disk-size */
    function diskSizeHuman(sizeBytes) {
      let size = sizeBytes;
      let label = ['B', 'K', 'M', 'G', 'T', 'P'];
      let count = 0;
      while (size / 1000 > 1 && count < label.length - 1) {
        size /= 1000;
        count++;
      }
      size = Math.round(size);
      return `${size}${label[count]}`;
    }

    /* Display disk information */
    function updateDiskInfo(diskObj) {
      document.getElementById('storage-device').innerHTML = 'da0';
      if (diskObj.size) document.getElementById('storage-size').innerHTML = diskSizeHuman(diskObj.size);
      if (diskObj.description) document.getElementById('storage-description').innerHTML = diskObj.description;
    }

    /* Get information about a particular disk. */
    function getDiskInfo(disk, callback) {
      let url = './disk/' + disk;
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Write configuration values */
    function writeConfig() {
      let trustedUsers = document.getElementById('trusted-users').value;
      let host = document.getElementById('host').value;
      let domain = document.getElementById('domain').value;
      let tzArea = document.getElementById('tz-area').options[document.getElementById('tz-area').selectedIndex].value;
      let tzLocation = document.getElementById('tz-location').options[document.getElementById('tz-location').selectedIndex].value;

      // At the very least, one trusted user is required.
      if (trustedUsers) {
        if (confirm('Overwrite system with new settings?')) {
          setHostname(host, domain);
          setTimezone(tzArea, tzLocation);
          addUsers(trustedUsers);
        }
      }
      else {
        alert('There must be at least one trusted user to administer the system.');
      }
    }
  </script>
</head>

<body onload="showHostname(); getDiskInfo('da0', updateDiskInfo);">
  <!-- Turn on night mode between the hours of 6 p.m. and 6 a.m. -->
  <script>let d = new Date(); if (d.getHours() < 6 || d.getHours() >= 18) document.getElementById('page-style').setAttribute('href', 'hello-night.css');</script>

  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>

  <nav>
    <p>
      <a href="admin.html">Administration</a>
    </p>
  </nav>

  <main class="narrow">
    <h2>System Customization</h2>

    <details id="credentials" open>
      <summary><span id="credentials-key" style="opacity: 0.25;"> &#x1F511;</span> Credentials</summary>
      <div style="margin-left: 1em;">
        <table>
          <tr>
            <td><label>Username</label></td>
            <td><input id="credentials-username" type="text"></td>
          </tr>
          <tr>
            <td><label>Password</label></td>
            <td><input id="credentials-password" type="password"
                onchange="createAuth(document.getElementById('credentials-username').value, document.getElementById('credentials-password').value, credentialsEntered);">
              <span id="credentials-state">&#x026D4;</span>
            </td>
          </tr>
        </table>
      </div>
    </details>

    <p><b>Trusted Users</b></p>
    <div onmouseover="toggleBlurb('trusted-user-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <input id="trusted-users" onfocus="toggleBlurb('trusted-user-blurb');" onblur="toggleBlurb('general-blurb');"
        placeholder="Lowercase only. Separate with spaces." size=42>
    </div>

    <p><b>Hostname</b></p>
    <div onmouseover="toggleBlurb('hostname-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <input id="host" onfocus="toggleBlurb('hostname-blurb');" onblur="toggleBlurb('general-blurb');"
        placeholder="weenas">
      .
      <input id="domain" onfocus="toggleBlurb('hostname-blurb');" onblur="toggleBlurb('general-blurb');"
        placeholder="local">
    </div>

    <p><b>Timezone</b></p>
    <div onmouseover="toggleBlurb('timezone-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <select id="tz-area" onfocus="toggleBlurb('timezone-blurb');" onblur="toggleBlurb('general-blurb');"
        onchange="tzUpdateLocations('tz-area', 'tz-location')">
        <option>Africa</option>
        <option>America</option>
        <option>Antarctica</option>
        <option>Asia</option>
        <option>Atlantic</option>
        <option>Australia</option>
        <option selected>Etc</option>
        <option>Europe</option>
        <option>Indian</option>
        <option>Pacific</option>
      </select>
      /
      <select id="tz-location" onfocus="toggleBlurb('timezone-blurb');" onblur="toggleBlurb('general-blurb');">
        <option>GMT</option>
      </select>
    </div>

    <p><b>USB Storage</b></p>
    <div onmouseover="toggleBlurb('storage-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <table>
        <tr>
          <td>Device</td>
          <td id="storage-device"></td>
        </tr>
        <tr>
          <td>Description</td>
          <td id="storage-description"></td>
        </tr>
        <tr>
          <td>Size</td>
          <td id="storage-size"></td>
        </tr>
      </table>
    </div>

    <p><b>Finalizing Customization</b></p>
    <div onmouseover="toggleBlurb('finalizing-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <p>
        <button class="wide" onclick="writeConfig();" title="Write configuration to device."
          type="button">&#x1F4CB;&#x0279C;&#x1F4BB;</button>
        <button class="wide" onfocus="toggleBlurb('built-in-blurb');" onblur="toggleBlurb('general-blurb');"
          title="Lock built-in user accounts." type="button">&#x1F512;</button>
      </p>
    </div>
  </main>

  <aside class="wide">
    <h2>Explanation</h2>
    <div id="general-blurb">
      <p>A few parameters are required to get WeeNAS customized for use:</p>
      <ol>
        <li>Trusted User(s)</li>
        <li>Hostname</li>
        <li>Timezone</li>
      </ol>
      <p>Once these values are entered, click the confirmation button to write their values to the WeeNAS host.</p>
      <p>
        You also have the option to lock the built-in FreeBSD accounts (freebsd and toor.) It is highly recommended
        that you do so after verifying connectivity with a trusted user account.
      </p>
    </div>
    <div id="trusted-user-blurb" style="display: none;">
      <p><b>Trusted Users</b></p>
      <p>
        These are the accounts that have shell access and the ability to su to root. Other accounts will not. Everything
        that has been done so far using the built-in freebsd account can be done with this user account. You must have
        at least one trusted user account, otherwise you will not be able to access the system via SSH at all once the
        built-in accounts are locked.
      </p>
      <p>
        Use lowercase letters and numbers if desired. Multiple user accounts should be separated with spaces.
      </p>
    </div>
    <div id="hostname-blurb" style="display: none;">
      <p><b>Hostname</b></p>
      <p>
        Enter the name that you would like your WeeNAS device to appear as. The name should be in all lowercase letters
        and not contain an special characters other than a dash. The length should be constrained to fifteen characters
        or less. (This is a NetBIOS limitation.)
      </p>
      <p>
        The domain name can be entered if you have a registered domain name. If not, just enter 'local'. There is no
        need to enter a leading dot to separate the host and domain names. This is taken care of automatically.
      </p>
    </div>
    <div id="timezone-blurb" style="display: none;">
      <p><b>Timezone</b></p>
      <p>
        Choosing a timezone consists of two steps. First, choose the area in which you live. This is either one of the
        continental land masses or an ocean for island nations. Next, choose the city closest to you.
      </p>
      <p>
        For example, if you live in Noisy-le-Roi, an area west of Paris, France, choose Europe/Paris for the timezone
        area and location.
      </p>
    </div>
    <div id="storage-blurb" style="display: none;">
      <p><b>USB Storage Device</b></p>
      <p>
        The parameters shown here are purely informational.
      </p>
      <p> You should see the USB flash drive that was configured when the install.sh script was run. If you do not see
        the correct device, verify that the only USB storage device plugged in is the one you intend to use for home
        drives. Proceeding with the wrong device means users will have trouble accessing their home drives.
      </p>
    </div>
    <div id="finalizing-blurb" style="display: none;">
      <p><b>Finalizing Custom Settings</b></p>

      <p>Writing Settings</p>
      <p>Click the button showing a clipboard and a computer to write the customized settings to your WeeNAS system.</p>

      <p>Testing Connectivity</p>
      <p>
        Take a moment to verify that you can connect via SSH to the Raspberry Pi and log in using your trusted user and
        password. Also test the ability to su to root using this account. If everything checks out, click the button
        with the padlock to lock the built-in accounts.
      </p>

      <p>Locking Built-In Accounts</p>
      <p>
        The accounts, freebsd and toor, come built into every FreeBSD system and are secured by trivial passwords. This
        makes system set-up very easy, but also creates an easy way for malicious users to gain access. After verifying
        SSH connectivity, it is highly recommended that you lock these accounts and only use the trusted account(s) to
        access the system.
      </p>
    </div>
  </aside>

  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank">WeeNAS = Raspberry Pi + Flash Drive + FreeBSD
        + Samba</a></p>
  </footer>
</body>

</html>