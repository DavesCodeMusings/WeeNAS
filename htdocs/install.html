<!DOCTYPE html>

<html lang="en-US">

<head>
  <title>WeeNAS Initial Configuration</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="hello.css" rel="stylesheet" type="text/css">

  <script src="tzNamesLib.js"></script>
  <script>
    /* Figure out whence we came and put the hostname in the header. */
    function showHostname() {
      if (window.location.hostname) {
        document.getElementById('hostname').innerHTML = window.location.hostname;
      }
    }

    /* Change the visibility of DIV elements as focus on input areas is changed. */
    function toggleBlurb(elementId) {
      document.getElementById('general-blurb').style.display = 'none';
      document.getElementById('trusted-user-blurb').style.display = 'none';
      document.getElementById('hostname-blurb').style.display = 'none';
      document.getElementById('timezone-blurb').style.display = 'none';
      document.getElementById('storage-blurb').style.display = 'none';
      document.getElementById('built-in-blurb').style.display = 'none';
      document.getElementById(elementId).style.display = 'block';
    }

    /* Human readable disk-size */
    function diskSizeHuman(sizeBytes) {
      let size = sizeBytes;
      let label = ['B', 'K', 'M', 'G', 'T', 'P'];
      let count = 0;
      while (size / 1000 > 1 && count < label.length - 1) {
        size /= 1000;
        count++;
      }
      size = Math.round(size);
      return `${size}${label[count]}`;
    }

    /* Display disk information */
    function updateDiskInfo(diskObj) {
      if (diskObj.size) document.getElementById('storage-size').innerHTML = diskSizeHuman(diskObj.size);
      if (diskObj.description) document.getElementById('storage-description').innerHTML = diskObj.description;
    }

    /* Get information about a particular disk. */
    function getDiskInfo(disk, callback) {
      let url = './disk/' + disk;
      document.body.style.cursor = 'wait';
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4) {
          if (this.status == 200) callback(JSON.parse(this.responseText));
          else alert('Error: ' + this.responseText);
          document.body.style.cursor = 'default';
        }
      };
      xhttp.open('GET', url, true);
      xhttp.send();
    }

    /* Write configuration values */
    function writeConfig() {
      let missing = '';
      if (!document.getElementById('trusted-users').value) {
        missing += 'Trusted user account. ';
      }
      if (!document.getElementById('host').value) {
        missing += 'Host name. ';
      }
      if (!document.getElementById('domain').value) {
        missing += 'Domain name. ';
      }
      if (!missing) {
        confirm('Writing config.');
      }
      else {
        alert('The following items are missing values and must be fixed before the configuration can be written:\n\n' + missing);
      }
    }
  </script>
</head>

<body onload="showHostname(); getDiskInfo('da0', updateDiskInfo);">
  <header>
    <h1 id="hostname">WeeNAS</h1>
  </header>

  <nav>
    <p>
    </p>
  </nav>

  <main class="narrow">
    <h2>Initial Configuration</h2>

    <p><b>Trusted Users</b></p>
    <div onmouseover="toggleBlurb('trusted-user-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <input id="trusted-users" onfocus="toggleBlurb('trusted-user-blurb');" onblur="toggleBlurb('general-blurb');">
    </div>

    <p><b>Hostname</b></p>
    <div onmouseover="toggleBlurb('hostname-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <input id="host" onfocus="toggleBlurb('hostname-blurb');" onblur="toggleBlurb('general-blurb');"
        placeholder="weenas">
      .
      <input id="domain" onfocus="toggleBlurb('hostname-blurb');" onblur="toggleBlurb('general-blurb');"
        placeholder="local">
    </div>

    <p><b>Timezone</b></p>
    <div onmouseover="toggleBlurb('timezone-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <select id="timezone-area" onfocus="toggleBlurb('timezone-blurb');" onblur="toggleBlurb('general-blurb');"
        onchange="tzUpdateLocations('timezone-area', 'timezone-location')">
        <option>Africa</option>
        <option>America</option>
        <option>Antarctica</option>
        <option>Asia</option>
        <option>Atlantic</option>
        <option>Australia</option>
        <option selected>Etc</option>
        <option>Europe</option>
        <option>Indian</option>
        <option>Pacific</option>
      </select>
      /
      <select id="timezone-location" onfocus="toggleBlurb('timezone-blurb');" onblur="toggleBlurb('general-blurb');">
        <option>GMT</option>
      </select>
    </div>

    <p><b>USB Storage</b></p>
    <div onmouseover="toggleBlurb('storage-blurb');" onmouseout="toggleBlurb('general-blurb');"
      style="margin-left: 1em;">
      <table>
        <tr>
          <td>Device</td>
          <td><input id="storage-device"  onfocus="toggleBlurb('storage-blurb');" onblur="toggleBlurb('general-blurb');" readonly value="da0"></td>
        </tr>
        <tr>
          <td>Description</td>
          <td id="storage-description"></td>
        </tr>
        <tr>
          <td>Size</td>
          <td id="storage-size"></td>
        </tr>
      </table>
    </div>

    <p><b>Built-In Accounts</b></p>
    <div onmouseover="toggleBlurb('built-in-blurb');" onmouseout="toggleBlurb('general-blurb');" style="margin-left: 1em;">
    <input checked id="lock-built-in" onfocus="toggleBlurb('built-in-blurb');" onblur="toggleBlurb('general-blurb');"
      type="checkbox"> Lock freebsd and toor user accounts.
    </div>

    <p><b>Confirmation</b></p>
    <div style="margin-left: 1em;">
    <p>
      <button class="wide" onclick="writeConfig();" title="Write configuration to device."
        type="button">&#x1F4CB;&#x0279C;&#x1F4BB;</button>
    </p>
    </div>
  </main>

  <aside class="wide">
    <h2>Explanation</h2>
    <div id="general-blurb">
      <p>A few parameters are required to get WeeNAS configured for use:</p>
      <ol>
        <li>Trusted User(s)</li>
        <li>Hostname</li>
        <li>Timezone</li>
      </ol>
      <p>
        You also have the option to lock the built-in FreeBSD accounts (freebsd and toor.) It is highly recommended
        that you do so.
      </p>
      <p>Once these values are entered, click the confirmation button to write their values to the WeeNAS host.</p>
    </div>
    <div id="trusted-user-blurb" style="display: none;">
      <p><b>Trusted Users</b></p>
      <p>
        These are the accounts that have shell access and the ability to su to root. Other accounts will not. Everything
        that has been done so far using the built-in freebsd account can be done with this user account. You must have
        at least one trusted user account, otherwise you will not be able to access the system via SSH at all once the
        built-in accounts are locked.
      </p>
      <p>
        Use lowercase letters and numbers if desired. Multiple user accounts should be separated with spaces.
      </p>
    </div>
    <div id="hostname-blurb" style="display: none;">
      <p><b>Hostname</b></p>
      <p>
        Enter the name that you would like your WeeNAS device to appear as. The name should be in all lowercase letters
        and not contain an special characters other than a dash. The length should be constrained to fifteen characters
        or less. (This is a NetBIOS limitation.)
      </p>
      <p>
        The domain name can be entered if you have a registered domain name. If not, just enter 'local'. There is no
        need to enter a leading dot to separate the host and domain names. This is taken care of automatically.
      </p>
    </div>
    <div id="timezone-blurb" style="display: none;">
      <p><b>Timezone</b></p>
      <p>
        Choosing a timezone consists of two steps. First, choose the area in which you live. This is either one of the
        continental land masses or an ocean for island nations. Next, choose the city closest to you.
      </p>
      <p>
        For example, if you live in Noisy-le-Roi, an area west of Paris, France, choose Europe/Paris for the timezone
        area and location.
      </p>
    </div>
    <div id="storage-blurb" style="display: none;">
      <p><b>USB Storage Device</b></p>
      <p>
        The MicroSD card in the Raspberry Pi is dedicated to the operating system. You'll need to insert a flash drive
        into one of the Raspberry Pi's USB ports to provide space for users' home directories and the shared drive.
        This separation of devices for operating system and user data not only gives you more home drive space, but it
        makes future upgrades much easier.
      </p>
      <p>
        <em>Insert only the USB flash drive you plan to use for home directories at this time.</em>
      </p>
      <p>
        The contents of the flash drive will be overwritten and configured for compatibility with FreeBSD. Any data on
        the flash drive will be lost.
      </p>
    </div>
    <div id="built-in-blurb" style="display: none;">
      <p><b>Built-In Accounts</b></p>
      <p>
        The accounts, freebsd and toor, come built into every FreeBSD system and are secured by trivial passwords. This
        makes system set-up very easy, but also creates an easy way in for malicious users. It is suggested that you
        lock both of these accounts and only use the trusted account(s) to access the system.
      </p>
    </div>
  </aside>

  <footer>
    <p><a href="https://davescodemusings.github.io/WeeNAS" target="_blank" style="color: whitesmoke;">WeeNAS Project
        Home</a></p>
  </footer>
</body>

</html>